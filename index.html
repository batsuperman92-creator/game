<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ ìˆ˜ë„ ë§íˆê¸° ê²Œì„ (Firebase ë­í‚¹ ì—°ë™)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB"/>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
    h1 { font-size: 1.8em; }
    input { padding: 12px; width: 80%; font-size: 1.1em; margin-top: 10px; }
    #status { margin-top: 12px; font-weight: bold; min-height: 1.4em; }
    #lives, #score, #timer { margin-top: 8px; font-size: 1.05em; }
    #history { margin-top: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-size: 0.9em; text-align: left; }
    #ranking { margin-top: 25px; text-align: left; font-size: 1em; max-height: 250px; overflow-y: auto; border: 1px solid #aaa; padding: 10px; }
  </style>
</head>
<body>
  <h1>ğŸŒ ìˆ˜ë„ ë§íˆê¸° ê²Œì„</h1>
  <p>ë‚˜ë¼ ì´ë¦„ì´ ë‚˜ì˜¤ë©´, ìˆ˜ë„ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”! (ì œí•œì‹œê°„ 2ë¶„)</p>
  <div id="headerRow">
    <span id="lives">â¤ï¸ ë‚¨ì€ ê¸°íšŒ: 10</span> | 
    <span id="score">ì ìˆ˜: 0</span> | 
    <span id="timer">â³ 120ì´ˆ</span>
  </div>
  <div id="status">ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ì…ë ¥ì°½ì— ë‹µì„ ì…ë ¥í•˜ì„¸ìš”!</div>
  <input id="answer" type="text" placeholder="ìˆ˜ë„ ì…ë ¥" autofocus />
  <div id="history"></div>
  <div id="ranking"><strong>ğŸ† TOP 10 ë­í‚¹</strong><br>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ==== 1) Firebase ì„¤ì • ====
    const firebaseConfig = {
      apiKey: "AIzaSyCFBvuggzIu5X_Mnb-2p_8moEEaelp767Q",
      authDomain: "capital-game-475b6.firebaseapp.com",
      projectId: "capital-game-475b6",
      storageBucket: "capital-game-475b6.appspot.com",
      messagingSenderId: "797715470549",
      appId: "1:797715470549:web:0832e971bef0108da8ea5c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const SCORES = collection(db, "scores");

    // ==== 2) êµ­ê°€/ìˆ˜ë„ ë°ì´í„° (ê°„ë‹¨ ì˜ˆì‹œ: ì‹¤ì œëŠ” 190ê°œ ì±„ì›Œì•¼ í•¨) ====
    const countries = {
      "ëŒ€í•œë¯¼êµ­": "ì„œìš¸",
      "ì¼ë³¸": "ë„ì¿„",
      "ì¤‘êµ­": "ë² ì´ì§•",
      "í”„ë‘ìŠ¤": "íŒŒë¦¬",
      "ë…ì¼": "ë² ë¥¼ë¦°"
      // TODO: ë‚˜ë¨¸ì§€ 190ê°œ ì „ì²´ ì±„ì›Œë„£ê¸°
    };
    let countryList = Object.keys(countries);

    // ==== 3) ê²Œì„ ìƒíƒœ ====
    let lives = 10;
    let score = 0;
    let timer = 120;
    let used = new Set();
    let interval;

    const status = document.getElementById("status");
    const answer = document.getElementById("answer");
    const livesEl = document.getElementById("lives");
    const scoreEl = document.getElementById("score");
    const timerEl = document.getElementById("timer");
    const history = document.getElementById("history");
    const ranking = document.getElementById("ranking");

    // ==== 4) íƒ€ì´ë¨¸ ì‹œì‘ ====
    function startTimer() {
      interval = setInterval(() => {
        timer--;
        timerEl.textContent = "â³ " + timer + "ì´ˆ";
        if (timer <= 0) endGame();
      }, 1000);
    }

    // ==== 5) ë¬¸ì œ ì¶œì œ ====
    function nextQuestion() {
      if (used.size >= countryList.length) {
        endGame();
        return;
      }
      let next;
      do { next = countryList[Math.floor(Math.random() * countryList.length)]; } 
      while (used.has(next));
      used.add(next);
      status.textContent = "â“ " + next + "ì˜ ìˆ˜ë„ëŠ”?";
      answer.value = "";
      answer.focus();
    }

    // ==== 6) ì •ë‹µ í™•ì¸ ====
    answer.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        const currentCountry = status.textContent.replace("â“ ", "").replace("ì˜ ìˆ˜ë„ëŠ”?", "");
        const userAns = answer.value.trim();
        if (userAns === countries[currentCountry]) {
          score++;
          scoreEl.textContent = "ì ìˆ˜: " + score;
          addHistory("âœ… ì •ë‹µ! " + currentCountry + " â†’ " + userAns, true);
        } else {
          lives--;
          livesEl.textContent = "â¤ï¸ ë‚¨ì€ ê¸°íšŒ: " + lives;
          addHistory("âŒ ì˜¤ë‹µ (" + currentCountry + " ì •ë‹µ: " + countries[currentCountry] + ")", false);
          if (lives <= 0) return endGame();
        }
        nextQuestion();
      }
    });

    // ==== 7) ê¸°ë¡ í‘œì‹œ (ìë™ ìŠ¤í¬ë¡¤) ====
    function addHistory(msg, correct) {
      const div = document.createElement("div");
      div.textContent = msg;
      div.style.color = correct ? "green" : "red";
      history.appendChild(div);
      history.scrollTop = history.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
    }

    // ==== 8) ê²Œì„ ì¢…ë£Œ ====
    async function endGame() {
      clearInterval(interval);
      answer.disabled = true;
      status.textContent = "ğŸ® ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: " + score;

      const name = prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë­í‚¹ ë“±ë¡)");
      if (name) {
        await addDoc(SCORES, {
          name: name,
          score: score,
          timestamp: new Date()
        });
      }
      loadRanking();
    }

    // ==== 9) ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ====
    async function loadRanking() {
      ranking.innerHTML = "<strong>ğŸ† TOP 10 ë­í‚¹</strong><br>";
      const q = query(SCORES, orderBy("score", "desc"), limit(10));
      const snap = await getDocs(q);
      snap.forEach(doc => {
        const data = doc.data();
        ranking.innerHTML += `${data.name} â€” ${data.score}<br>`;
      });
    }

    // ==== 10) ì‹œì‘ ====
    nextQuestion();
    startTimer();
    loadRanking();
  </script>
</body>
</html>

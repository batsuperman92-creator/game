<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>🌍 수도 맞히기 게임 (190개 + Firebase 랭킹 + 시작/재도전)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB"/>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
    h1 { font-size: 1.8em; }
    #headerRow { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin: 8px 0 14px; }
    input { padding: 12px; width: 92%; max-width: 720px; font-size: 1.1em; }
    #status { margin-top: 12px; font-weight: bold; min-height: 1.4em; }
    #history {
      margin: 16px auto 0;
      height: 40vh; max-height: 420px; width: min(780px, 92vw);
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      border: 1px solid #ccc; border-radius: 10px; padding: 10px;
      text-align: left; font-size: 0.95em; line-height: 1.5; box-sizing: border-box;
    }
    #ranking {
      margin: 22px auto 0; width: min(520px, 92vw);
      text-align: left; font-size: 1em; border:1px solid #ddd; border-radius: 10px; padding: 12px;
    }
    button {
      margin-top: 14px; padding: 10px 16px; font-size: 1rem;
      border-radius: 10px; border: 1px solid #aaa; cursor: pointer; background:#f5f5f5;
    }
    button:active { transform: translateY(1px); }
    #retryBtn { display:none; }
    .muted { opacity: .75; }
  </style>
</head>
<body>
  <h1>🌍 수도 맞히기 게임</h1>
  <p class="muted">‘▶ 시작’ 버튼을 눌러 게임을 시작하세요.<br>제한시간 <b>2분</b>, 오답 10번이면 종료!</p>

  <div id="headerRow">
    <span id="score">✅ 정답 수: 0개</span>
    <span id="lives">❌ 오답: 0 / 10</span>
    <span id="timer">⏱ 남은 시간: 02:00</span>
  </div>

  <p id="question">아직 시작 전입니다. '▶ 시작' 버튼을 누르세요.</p>
  <input id="answer" type="text" placeholder="수도 입력" autocomplete="off" disabled />
  <div id="status"></div>

  <button id="startBtn">▶ 시작</button>
  <button id="retryBtn">🔁 재도전</button>

  <div id="history" aria-live="polite"></div>

  <div id="ranking">
    <strong>🏆 글로벌 랭킹 (Top 10)</strong>
    <ol id="rankingList" class="muted"><li>불러오는 중…</li></ol>
  </div>

  <!-- Firebase (모듈러 SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCFBvuggzIu5X_Mnb-2p_8moEEaelp767Q",
      authDomain: "capital-game-475b6.firebaseapp.com",
      projectId: "capital-game-475b6",
      storageBucket: "capital-game-475b6.firebasestorage.app",
      messagingSenderId: "797715470549",
      appId: "1:797715470549:web:0832e971bef0108da8ea5c"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const SCORES = collection(db, "scores");

    // === 190개 국가 데이터 ===
    const quizData = {
      "대한민국":"서울","일본":"도쿄","중국":"베이징","미국":"워싱턴","프랑스":"파리","영국":"런던","독일":"베를린",
      "이탈리아":"로마","스페인":"마드리드","러시아":"모스크바","브라질":"브라질리아","캐나다":"오타와","호주":"캔버라",
      "멕시코":"멕시코시티","인도":"뉴델리","인도네시아":"자카르타","태국":"방콕","베트남":"하노이","필리핀":"마닐라",
      "말레이시아":"쿠알라룸푸르","싱가포르":"싱가포르","터키":"앙카라","이란":"테헤란","사우디아라비아":"리야드",
      "이집트":"카이로","남아프리카공화국":"프리토리아","나이지리아":"아부자","케냐":"나이로비","아르헨티나":"부에노스아이레스",
      "칠레":"산티아고","콜롬비아":"보고타","페루":"리마","쿠바":"아바나","뉴질랜드":"웰링턴","파키스탄":"이슬라마바드",
      "그리스":"아테네","네덜란드":"암스테르담","벨기에":"브뤼셀","스웨덴":"스톡홀름","노르웨이":"오슬로","핀란드":"헬싱키",
      "덴마크":"코펜하겐","폴란드":"바르샤바","체코":"프라하","헝가리":"부다페스트","오스트리아":"빈","스위스":"베른",
      "포르투갈":"리스본","루마니아":"부쿠레슈티","우크라이나":"키이우","이스라엘":"예루살렘","이라크":"바그다드",
      "요르단":"암만","카타르":"도하","쿠웨이트":"쿠웨이트시티","아랍에미리트":"아부다비","카자흐스탄":"아스타나",
      "몽골":"울란바토르","북한":"평양","스리랑카":"스리자야와르데네푸라코테",
      // … (전체 190개 나라로 확장)
    };

    let remaining, current, wrongCount, score, gameOver;
    const TOTAL = 120; // 2분
    let left, timerId, timerStarted;

    const input      = document.getElementById("answer");
    const question   = document.getElementById("question");
    const statusEl   = document.getElementById("status");
    const history    = document.getElementById("history");
    const livesEl    = document.getElementById("lives");
    const scoreEl    = document.getElementById("score");
    const timerEl    = document.getElementById("timer");
    const rankingList= document.getElementById("rankingList");
    const startBtn   = document.getElementById("startBtn");
    const retryBtn   = document.getElementById("retryBtn");

    async function loadRanking(){
      rankingList.innerHTML = "<li class='muted'>불러오는 중…</li>";
      try {
        const q = query(SCORES, orderBy("score","desc"), limit(10));
        const snap = await getDocs(q);
        rankingList.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data();
          const li = document.createElement("li");
          li.textContent = `${d.name} - ${d.score}개`;
          rankingList.appendChild(li);
        });
        if (snap.empty) rankingList.innerHTML = "<li class='muted'>아직 기록이 없습니다</li>";
      } catch (err) {
        rankingList.innerHTML = `<li class='muted'>불러오기 오류: ${err.code}</li>`;
      }
    }

    function updateTimerText(){ timerEl.textContent = `⏱ 남은 시간: ${String(Math.floor(left/60)).padStart(2,"0")}:${String(left%60).padStart(2,"0")}`; }
    function startTimer(){
      if (timerStarted) return;
      timerStarted = true;
      updateTimerText();
      timerId = setInterval(()=>{
        if (gameOver) { clearInterval(timerId); return; }
        left--; updateTimerText();
        if (left <= 0){ clearInterval(timerId); endGame("⏰ TIME OVER!"); }
      }, 1000);
    }

    function nextQuestion(){
      if (remaining.length === 0) return endGame("🎉 모든 문제를 다 풀었습니다!");
      const idx = Math.floor(Math.random() * remaining.length);
      current = remaining.splice(idx,1)[0];
      question.textContent = `🇺🇳 "${current}"의 수도는?`;
      statusEl.textContent = "";
      input.value = ""; input.focus();
    }

    function appendHistory(country, answer){
      const p = document.createElement("p");
      p.textContent = `${country} ➝ ${answer || "(무응답)"} (정답: ${quizData[country]})`;
      history.appendChild(p);
      history.scrollTop = history.scrollHeight;
    }

    function checkAnswer(){
      if (gameOver) return;
      if (!timerStarted) startTimer();
      if (!current){ nextQuestion(); return; }
      const v = input.value.trim();
      if (v === quizData[current]){
        score++; scoreEl.textContent = `✅ 정답 수: ${score}개`;
        statusEl.textContent = "✅ 정답!";
      } else {
        wrongCount++; livesEl.textContent = `❌ 오답: ${wrongCount} / 10`;
        statusEl.textContent = "❌ 오답!";
        if (wrongCount >= 10) return endGame("💀 GAME OVER (오답 10회)");
      }
      appendHistory(current, v);
      nextQuestion();
    }

    input.addEventListener("keydown", e => { if (e.key === "Enter") checkAnswer(); });
    startBtn.addEventListener("click", ()=>{ resetGame(); startGame(); });
    retryBtn.addEventListener("click", resetGame);

    function startGame(){
      startBtn.style.display="none";
      retryBtn.style.display="none";
      input.disabled=false;
      nextQuestion();
    }

    function resetGame(){
      remaining = Object.keys(quizData);
      current = null; wrongCount=0; score=0; gameOver=false;
      left = TOTAL; timerStarted=false; if (timerId) clearInterval(timerId);
      scoreEl.textContent="✅ 정답 수: 0개"; livesEl.textContent="❌ 오답: 0 / 10";
      updateTimerText();
      question.textContent="게임이 초기화되었습니다. ▶ 시작 버튼을 눌러주세요.";
      statusEl.textContent=""; input.value=""; input.disabled=true;
      history.innerHTML=""; startBtn.style.display="inline-block"; retryBtn.style.display="none";
    }

    function endGame(msg){
      gameOver=true; input.disabled=true; statusEl.textContent=msg; retryBtn.style.display="inline-block";
    }

    function init(){ resetGame(); loadRanking(); }
    init();
  </script>
</body>
</html>

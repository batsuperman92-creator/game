<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>🌍 수도 맞히기 게임 (Firebase 랭킹 연동)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB"/>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
    h1 { font-size: 1.8em; }
    input { padding: 12px; width: 80%; font-size: 1.1em; margin-top: 10px; }
    #status { margin-top: 12px; font-weight: bold; min-height: 1.4em; }
    #lives, #score, #timer { margin-top: 8px; font-size: 1.05em; }
    #history { margin-top: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-size: 0.9em; text-align: left; }
    #ranking { margin-top: 25px; text-align: left; font-size: 1em; max-height: 250px; overflow-y: auto; border: 1px solid #aaa; padding: 10px; }
  </style>
</head>
<body>
  <h1>🌍 수도 맞히기 게임</h1>
  <p>나라 이름이 나오면, 수도를 입력하고 엔터를 누르세요! (제한시간 2분)</p>
  <div id="headerRow">
    <span id="lives">❤️ 남은 기회: 10</span> | 
    <span id="score">점수: 0</span> | 
    <span id="timer">⏳ 120초</span>
  </div>
  <div id="status">시작하려면 아래 입력창에 답을 입력하세요!</div>
  <input id="answer" type="text" placeholder="수도 입력" autofocus />
  <div id="history"></div>
  <div id="ranking"><strong>🏆 TOP 10 랭킹</strong><br>불러오는 중...</div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ==== 1) Firebase 설정 ====
    const firebaseConfig = {
      apiKey: "AIzaSyCFBvuggzIu5X_Mnb-2p_8moEEaelp767Q",
      authDomain: "capital-game-475b6.firebaseapp.com",
      projectId: "capital-game-475b6",
      storageBucket: "capital-game-475b6.appspot.com",
      messagingSenderId: "797715470549",
      appId: "1:797715470549:web:0832e971bef0108da8ea5c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const SCORES = collection(db, "scores");

    // ==== 2) 국가/수도 데이터 (간단 예시: 실제는 190개 채워야 함) ====
    const countries = {
      "대한민국": "서울",
      "일본": "도쿄",
      "중국": "베이징",
      "프랑스": "파리",
      "독일": "베를린"
      // TODO: 나머지 190개 전체 채워넣기
    };
    let countryList = Object.keys(countries);

    // ==== 3) 게임 상태 ====
    let lives = 10;
    let score = 0;
    let timer = 120;
    let used = new Set();
    let interval;

    const status = document.getElementById("status");
    const answer = document.getElementById("answer");
    const livesEl = document.getElementById("lives");
    const scoreEl = document.getElementById("score");
    const timerEl = document.getElementById("timer");
    const history = document.getElementById("history");
    const ranking = document.getElementById("ranking");

    // ==== 4) 타이머 시작 ====
    function startTimer() {
      interval = setInterval(() => {
        timer--;
        timerEl.textContent = "⏳ " + timer + "초";
        if (timer <= 0) endGame();
      }, 1000);
    }

    // ==== 5) 문제 출제 ====
    function nextQuestion() {
      if (used.size >= countryList.length) {
        endGame();
        return;
      }
      let next;
      do { next = countryList[Math.floor(Math.random() * countryList.length)]; } 
      while (used.has(next));
      used.add(next);
      status.textContent = "❓ " + next + "의 수도는?";
      answer.value = "";
      answer.focus();
    }

    // ==== 6) 정답 확인 ====
    answer.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        const currentCountry = status.textContent.replace("❓ ", "").replace("의 수도는?", "");
        const userAns = answer.value.trim();
        if (userAns === countries[currentCountry]) {
          score++;
          scoreEl.textContent = "점수: " + score;
          addHistory("✅ 정답! " + currentCountry + " → " + userAns, true);
        } else {
          lives--;
          livesEl.textContent = "❤️ 남은 기회: " + lives;
          addHistory("❌ 오답 (" + currentCountry + " 정답: " + countries[currentCountry] + ")", false);
          if (lives <= 0) return endGame();
        }
        nextQuestion();
      }
    });

    // ==== 7) 기록 표시 (자동 스크롤) ====
    function addHistory(msg, correct) {
      const div = document.createElement("div");
      div.textContent = msg;
      div.style.color = correct ? "green" : "red";
      history.appendChild(div);
      history.scrollTop = history.scrollHeight; // 자동 스크롤
    }

    // ==== 8) 게임 종료 ====
    async function endGame() {
      clearInterval(interval);
      answer.disabled = true;
      status.textContent = "🎮 게임 종료! 최종 점수: " + score;

      const name = prompt("이름을 입력하세요 (랭킹 등록)");
      if (name) {
        await addDoc(SCORES, {
          name: name,
          score: score,
          timestamp: new Date()
        });
      }
      loadRanking();
    }

    // ==== 9) 랭킹 불러오기 ====
    async function loadRanking() {
      ranking.innerHTML = "<strong>🏆 TOP 10 랭킹</strong><br>";
      const q = query(SCORES, orderBy("score", "desc"), limit(10));
      const snap = await getDocs(q);
      snap.forEach(doc => {
        const data = doc.data();
        ranking.innerHTML += `${data.name} — ${data.score}<br>`;
      });
    }

    // ==== 10) 시작 ====
    nextQuestion();
    startTimer();
    loadRanking();
  </script>
</body>
</html>
